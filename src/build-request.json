{
  "kind": "build_request",
  "title": "Fix authentication state propagation and revert unintended UI changes",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-71",
      "text": "Fix authentication state propagation in useAuth context so that after successful login (both Internet Identity and email/password), the isAuthenticated flag and user state update immediately and synchronously across all consuming components (Header, protected routes, profile queries) without race conditions or delays",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "You successfully logged in and are authenticated",
          "But the Header still shows 'Login' instead of your profile/admin links",
          "You can't access your admin panel or profile pages"
        ]
      },
      "acceptanceCriteria": [
        "After successful login via Internet Identity, Header immediately shows profile dropdown and admin link instead of 'Login' button",
        "After successful login via email/password, Header immediately shows profile dropdown and admin link instead of 'Login' button",
        "Authentication state change triggers synchronous re-render of all consuming components",
        "No delays or race conditions between login completion and UI update"
      ]
    },
    {
      "id": "REQ-72",
      "text": "Ensure actor initialization completes successfully and is fully available before any authenticated UI components (Header, profile queries, admin checks) attempt to render or execute queries, preventing undefined actor errors",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "You can't access your admin panel or profile pages"
        ]
      },
      "acceptanceCriteria": [
        "Actor is fully initialized before Header renders authenticated UI",
        "Actor is fully initialized before profile queries execute",
        "Actor is fully initialized before admin panel access checks run",
        "No undefined actor errors occur during authentication flow"
      ]
    },
    {
      "id": "REQ-73",
      "text": "Invalidate and refetch user profile queries immediately after successful login (both Internet Identity and email/password) to ensure profile data including role information (admin/premium status) is fetched and available, triggering Header re-render with correct profile dropdown and admin link",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "You can't access your admin panel or profile pages"
        ]
      },
      "acceptanceCriteria": [
        "Profile queries are invalidated immediately after login completes",
        "Profile data including admin/premium status is fetched before Header renders",
        "Header receives fresh profile data including role information",
        "Admin link appears in Header when user has admin role",
        "Profile page is accessible immediately after login"
      ]
    },
    {
      "id": "REQ-74",
      "text": "Remove or refactor any LiveTVSyncPlayer initialization, mounting, or polling logic that interferes with authentication flow, actor creation, or session management, ensuring sync player does not block login or create circular dependencies with auth initialization",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Login (both Internet Identity and email/password) is broken with a loading loop after requesting Live TV synchronization features"
        ]
      },
      "acceptanceCriteria": [
        "LiveTVSyncPlayer does not interfere with login flow",
        "LiveTVSyncPlayer does not block actor initialization",
        "LiveTVSyncPlayer does not reset authentication context",
        "No circular dependencies between LiveTVSyncPlayer and authentication",
        "Login completes successfully without being stuck in loading state"
      ]
    },
    {
      "id": "REQ-75",
      "text": "Fix LoginPage navigation and redirect logic to successfully navigate users to the home page after login without triggering navigation during render, causing redirect loops, or leaving UI in a stuck loading state",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Login (both Internet Identity and email/password) is broken with a loading loop"
        ]
      },
      "acceptanceCriteria": [
        "After successful login, user is redirected to home page",
        "Navigation occurs only in useEffect or event handlers, not during render",
        "No redirect loops occur after login",
        "UI does not get stuck in loading state after login",
        "Redirect completes successfully for both Internet Identity and email/password login"
      ]
    },
    {
      "id": "REQ-76",
      "text": "Revert unintended visual changes to Header navigation component to restore expected appearance before recent updates, ensuring navigation links, spacing, styling, and layout match the original design without breaking responsive behavior or accessibility",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "You mentioned 'my Navigation reverted back' - can you describe what specifically looks wrong?",
          "I'm not telling you",
          "Navigation appearance is still wrong: The Header/navigation never changed back"
        ]
      },
      "acceptanceCriteria": [
        "Header navigation visual appearance matches state before recent authentication fixes",
        "Navigation links spacing is restored to original",
        "Navigation styling matches original design",
        "Layout structure is restored to original",
        "Responsive behavior works correctly on mobile and desktop",
        "Accessibility features remain intact"
      ]
    },
    {
      "id": "REQ-77",
      "text": "Review and revert any unintended UI changes across all pages and components that occurred during recent updates, restoring expected visual appearance, layout, and styling while preserving all functional improvements",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Navigation appearance is still wrong"
        ]
      },
      "acceptanceCriteria": [
        "All pages maintain their original visual appearance",
        "Layout and styling changes from recent updates are reverted where unintended",
        "Functional improvements from recent updates are preserved",
        "No visual regressions exist compared to state before recent authentication fixes"
      ]
    },
    {
      "id": "REQ-78",
      "text": "Add comprehensive error logging and debugging output throughout authentication flow (useAuth, useInternetIdentity, useActor) to capture timing information, state transitions, and exact failure points when login fails or gets stuck",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Login (both Internet Identity and email/password) is broken with a loading loop"
        ]
      },
      "acceptanceCriteria": [
        "Console logs show authentication state transitions",
        "Console logs show timing information for each authentication step",
        "Console logs identify exact failure points when login fails",
        "Console logs show actor initialization status",
        "Console logs show profile query execution status",
        "Error messages are clear and actionable for debugging"
      ]
    }
  ],
  "constraints": [
    "Do not modify immutable frontend paths: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui",
    "Maintain single-actor backend architecture in backend/main.mo",
    "Preserve all existing functional features while fixing authentication state synchronization",
    "Do not break existing LiveTVSyncPlayer functionality on LivePage when removing interference with auth flow"
  ],
  "nonGoals": [
    "Changing the technology stack (React, Motoko, Tailwind)",
    "Adding new authentication methods beyond Internet Identity and email/password",
    "Redesigning the Header navigation layout or structure beyond reverting unintended changes",
    "Refactoring LiveTVSyncPlayer implementation beyond removing auth interference",
    "Adding new features or functionality beyond fixing authentication and UI appearance"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}
{
  "kind": "build_request",
  "title": "Fix Header UI state after Internet Identity login",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-53",
      "text": "Update Header component to immediately re-render and reflect authenticated state when Internet Identity login completes, replacing the 'Login' button with profile dropdown and admin link for authenticated users",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-latest"
        ],
        "quotes": [
          "internet identity which it logged in, because I noticed a difference, its just I can't access my profile/admin panel because the button \"login\" is still there instead of whatever is supposed to be there after logging in."
        ]
      },
      "acceptanceCriteria": [
        "After successful Internet Identity login, Header shows profile dropdown instead of 'Login' button",
        "Admin link appears in Header for admin users after Internet Identity login",
        "Header updates without requiring page reload or manual navigation",
        "Profile and admin panel become accessible immediately after login completes"
      ]
    },
    {
      "id": "REQ-54",
      "text": "Fix useInternetIdentity hook and useAuth context to synchronously propagate authentication state changes to all consuming components (including Header) when Internet Identity login succeeds",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-latest"
        ]
      },
      "acceptanceCriteria": [
        "Authentication state updates propagate synchronously after Internet Identity login",
        "All components consuming auth context (Header, protected routes) receive updated state immediately",
        "isAuthenticated flag reflects true state without delay after successful login",
        "No race conditions between auth state update and component re-renders"
      ]
    },
    {
      "id": "REQ-55",
      "text": "Invalidate and refetch user profile queries immediately after Internet Identity login completes to ensure profile data and role information (admin/premium status) are available for Header rendering and navigation guards",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-latest"
        ]
      },
      "acceptanceCriteria": [
        "Profile query invalidation triggers immediately after Internet Identity authentication succeeds",
        "User role data (admin status) is fetched and available before Header attempts to render role-specific UI",
        "Query refetch completes before navigation or protected component rendering",
        "No undefined or stale profile data causes incorrect UI states in Header"
      ]
    },
    {
      "id": "REQ-56",
      "text": "Ensure actor initialization completes successfully after Internet Identity login before Header and other authenticated components attempt to render, preventing undefined actor errors in profile queries",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-latest"
        ]
      },
      "acceptanceCriteria": [
        "Actor instance is fully initialized with Internet Identity principal before profile queries execute",
        "Header waits for actor availability before attempting to fetch user profile data",
        "No 'actor is undefined' errors occur during post-login UI rendering",
        "Protected routes and admin checks have valid actor instance available"
      ]
    }
  ],
  "constraints": [
    "Do not modify useInternetIdentity.ts or useActor.ts (immutable paths)",
    "Preserve existing email/password authentication flows",
    "Keep Internet Identity login button on Login page functional",
    "Maintain backward compatibility with existing authentication state consumers"
  ],
  "nonGoals": [
    "Changing the visual design or layout of Header component",
    "Modifying backend authentication or access control logic",
    "Adding new authentication methods beyond Internet Identity and email/password",
    "Refactoring unrelated authentication flows"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}